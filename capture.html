<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Evidence Collection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header .progress {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input[type="text"],
        input[type="email"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .camera-section {
            margin: 20px 0;
        }

        video, .preview-image {
            width: 100%;
            border-radius: 8px;
            background: #000;
            margin: 12px 0;
        }

        .camera-controls {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .image-preview {
            position: relative;
            margin: 12px 0;
        }

        .preview-image {
            max-height: 400px;
            object-fit: contain;
        }

        .remove-image {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }

        .file-upload:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }

        .file-upload input {
            display: none;
        }

        .file-upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .pass-fail-toggle {
            display: flex;
            gap: 12px;
            margin: 20px 0;
        }

        .toggle-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-option.pass {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .toggle-option.fail {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .toggle-option.active.pass {
            background: #10b981;
            color: white;
        }

        .toggle-option.active.fail {
            background: #ef4444;
            color: white;
        }

        .success-screen {
            text-align: center;
            padding: 40px 0;
        }

        .success-icon {
            font-size: 72px;
            color: #10b981;
            margin-bottom: 20px;
        }

        .success-screen h2 {
            font-size: 24px;
            margin-bottom: 12px;
            color: #333;
        }

        .success-screen p {
            color: #666;
            margin-bottom: 30px;
        }

        .hidden {
            display: none;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 10px;
        }

        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s;
        }

        .step-dot.active {
            background: #667eea;
            transform: scale(1.3);
        }

        .step-dot.completed {
            background: #10b981;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="headerTitle">Legacy SST - Test Evidence Collection</h1>
            <div class="progress" id="progressText">Step 0 of 0</div>
        </div>

        <div class="content" id="appContent">
        </div>
    </div>

    <script>
        const CONFIG = {
            initialFields: [
                { id: 'testerName', label: 'Name', type: 'text', required: true },
                { id: 'testerId', label: 'ID Number', type: 'text', required: true },
                { id: 'applicationReason', label: 'Application Reason', type: 'text', required: true }
            ],

            steps: [
                {
                    id: 'Sign In',
                    title: 'Client Logs on to Terminal',
                    description: 'Take a photo of the application payment reference on the SST screen'
                },
                {
                    id: 'Select Smart ID Cards',
                    title: 'Capture selecting to Apply for a Smart ID Card',
                    description: 'Capture the Selecting of Apply for a Smart ID Card'
                },
                {
                    id: 'Select Apply',
                    title: 'Capture selecting to Apply for a Smart ID Card',
                    description: 'Capture the Selecting of Apply for a Smart ID Card'
                },
                {
                    id: 'Select Application Reason',
                    title: 'Capture selecting of Application Reason',
                    description: 'Capture the Selecting of Application Reason'
                },
                {
                    id: 'Application Process Screen',
                    title: 'Capture Application Process Screen',
                    description: 'Capture the Application Process Screen'
                },
                {
                    id: 'Tips for Taking an ID Photo',
                    title: 'Capture Tips for Taking an ID Photo',
                    description: 'Capture the Tips for Taking an ID Photo'
                },
                {
                    id: 'Take ID Photo',
                    title: 'Capture taking of ID Photo',
                    description: 'Capture the Taking of ID Photo'
                },
                {
                    id: 'Capture Left Hand Fingerprints',
                    title: 'Capture Left Hand Fingerprints',
                    description: 'Capture the Left Hand Fingerprints'
                },
                {
                    id: 'Capture Right Hand Fingerprints',
                    title: 'Capture Right Hand Fingerprints',
                    description: 'Capture the Right Hand Fingerprints'
                },
                {
                    id: 'Capture Confirm Details - Personal Information',
                    title: 'Capture Confirm Details - Person Information',
                    description: 'Capture the Confirm Details - Person Information'
                },
                {
                    id: 'Capture Confirm Details - Home Address Information',
                    title: 'Capture Confirm Details - Home Address Information',
                    description: 'Capture the Confirm Details - Home Address Information'
                },
                {
                    id: 'Capture Confirm Details - Contact Information',
                    title: 'Capture Confirm Details - Contact Information',
                    description: 'Capture the Confirm Details - Contact Information'
                },
                {
                    id: 'Capture Collection Address Information',
                    title: 'Capture Collection Address Information',
                    description: 'Capture the Collection Address Information'
                },
                {
                    id: 'Capture Declaration of Confirmation',
                    title: 'Capture Declaration of Confirmation',
                    description: 'Capture the Declaration of Confirmation'
                },
                {
                    id: 'Capture Declaration for Reason of Application',
                    title: 'Capture Declaration for Reason of Application',
                    description: 'Capture the Declaration for Reason of Application'
                },
                {
                    id: 'Capture Signature',
                    title: 'Capture Signature',
                    description: 'Capture the Signature'
                },
                {
                    id: 'Capture Making of Payment',
                    title: 'Capture Making of Payment',
                    description: 'Capture the Making of Payment'
                },
                {
                    id: 'Capture Fingerprint Consent for Payment',
                    title: 'Capture Fingerprint Consent for Payment',
                    description: 'Capture the Fingerprint Consent for Payment'
                },
                {
                    id: 'Capture Application Outstanding Requirements',
                    title: 'Capture Application Outstanding Requirements',
                    description: 'Capture the Application Outstanding Requirements'
                },
                {
                    id: 'Capture Application Saved',
                    title: 'Capture Application Saved',
                    description: 'Capture the Application Saved'
                }
            ]
        };

        const state = {
            currentStep: -1,
            testerInfo: {},
            stepData: [],
            stream: null,
            capturedPhoto: null
        };

        function init() {
            renderInitialForm();
        }

        function renderInitialForm() {
            updateProgress('Initial Information', 0);

            const fieldsHTML = CONFIG.initialFields.map(field => `
                <div class="form-group">
                    <label for="${field.id}">${field.label}${field.required ? ' *' : ''}</label>
                    <input
                        type="${field.type}"
                        id="${field.id}"
                        ${field.required ? 'required' : ''}
                    />
                </div>
            `).join('');

            document.getElementById('appContent').innerHTML = `
                ${fieldsHTML}
                <div class="button-group">
                    <button class="btn-primary" onclick="submitInitialForm()">Start Testing</button>
                </div>
            `;
        }

        function renderStep(stepIndex) {
            const step = CONFIG.steps[stepIndex];
            updateProgress(step.title, stepIndex + 1);

            if (!state.stepData[stepIndex]) {
                state.stepData[stepIndex] = {
                    stepId: step.id,
                    stepTitle: step.title,
                    photo: null,
                    notes: '',
                    status: null
                };
            }

            const currentData = state.stepData[stepIndex];

            document.getElementById('appContent').innerHTML = `
                <div class="step-indicator">
                    ${CONFIG.steps.map((s, i) => `
                        <div class="step-dot ${i === stepIndex ? 'active' : ''} ${i < stepIndex ? 'completed' : ''}"></div>
                    `).join('')}
                </div>

                <h2 style="margin-bottom: 8px;">${step.title}</h2>
                <p style="color: #666; margin-bottom: 24px;">${step.description}</p>

                <div class="camera-section">
                    <label>Evidence Photo *</label>

                    <div id="photoPreview" class="${currentData.photo ? '' : 'hidden'}">
                        ${currentData.photo ? `
                            <div class="image-preview">
                                <img src="${currentData.photo}" class="preview-image" />
                                <button class="remove-image" onclick="retakePhoto()">√ó</button>
                            </div>
                        ` : ''}
                    </div>

                    <div id="captureOptions" class="${currentData.photo ? 'hidden' : ''}">
                        <div id="cameraContainer" class="hidden">
                            <video id="video" autoplay playsinline></video>
                            <div class="camera-controls">
                                <button class="btn-primary" onclick="capturePhoto()">üì∑ Capture Photo</button>
                                <button class="btn-secondary" onclick="stopCamera()">Close Camera</button>
                            </div>
                        </div>

                        <div id="optionButtons">
                            <div class="camera-controls">
                                <button class="btn-primary" onclick="startCamera()">üì∑ Use Camera</button>
                            </div>

                            <div style="text-align: center; margin: 16px 0; color: #999; font-size: 14px;">OR</div>

                            <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                                <div class="file-upload-icon">üìÅ</div>
                                <p><strong>Upload an image</strong></p>
                                <p style="font-size: 12px; color: #666;">Click to select a file from your device</p>
                                <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Test Result *</label>
                    <div class="pass-fail-toggle">
                        <div class="toggle-option pass ${currentData.status === 'pass' ? 'active' : ''}" onclick="setStatus('pass')">
                            ‚úì Pass
                        </div>
                        <div class="toggle-option fail ${currentData.status === 'fail' ? 'active' : ''}" onclick="setStatus('fail')">
                            ‚úó Fail
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Notes & Observations</label>
                    <textarea id="notes" placeholder="Enter any observations, issues, or comments...">${currentData.notes}</textarea>
                </div>

                <div class="button-group">
                    ${stepIndex > 0 ? '<button class="btn-secondary" onclick="previousStep()">‚Üê Previous</button>' : ''}
                    <button class="btn-primary" onclick="nextStep()" id="nextBtn">
                        ${stepIndex === CONFIG.steps.length - 1 ? 'Complete Test' : 'Next ‚Üí'}
                    </button>
                </div>
            `;
        }

        function renderCompletion() {
            stopCamera();

            document.getElementById('appContent').innerHTML = `
                <div class="success-screen">
                    <div class="success-icon">‚úì</div>
                    <h2>Test Completed!</h2>
                    <p>All evidence has been collected successfully.</p>
                    <button class="btn-primary" onclick="downloadEvidence()">üì• Download Evidence Package</button>
                </div>
            `;
        }

        async function startCamera() {
            try {
                stopCamera();

                const constraints = {
                    video: {
                        facingMode: 'environment'
                    }
                };

                state.stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('video');
                if (video) {
                    video.srcObject = state.stream;
                    document.getElementById('cameraContainer').classList.remove('hidden');
                    document.getElementById('optionButtons')?.classList.add('hidden');
                }
            } catch (error) {
                console.error('Camera error:', error);
                alert('Unable to access camera. Please check permissions or use the upload option.');
            }
        }

        function stopCamera() {
            if (state.stream) {
                state.stream.getTracks().forEach(track => track.stop());
                state.stream = null;
            }
            const cameraContainer = document.getElementById('cameraContainer');
            if (cameraContainer) {
                cameraContainer.classList.add('hidden');
            }
            const optionButtons = document.getElementById('optionButtons');
            if (optionButtons) {
                optionButtons.classList.remove('hidden');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            const photoData = canvas.toDataURL('image/jpeg', 0.9);
            state.stepData[state.currentStep].photo = photoData;

            stopCamera();
            renderStep(state.currentStep);
        }

        function retakePhoto() {
            state.stepData[state.currentStep].photo = null;
            renderStep(state.currentStep);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.stepData[state.currentStep].photo = e.target.result;
                    renderStep(state.currentStep);
                };
                reader.readAsDataURL(file);
            }
        }

        function submitInitialForm() {
            let isValid = true;
            CONFIG.initialFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (field.required && !input.value.trim()) {
                    isValid = false;
                    input.style.borderColor = '#ef4444';
                } else {
                    state.testerInfo[field.id] = input.value.trim();
                    input.style.borderColor = '#e0e0e0';
                }
            });

            if (!isValid) {
                alert('Please fill in all required fields');
                return;
            }

            state.currentStep = 0;
            renderStep(0);
        }

        function setStatus(status) {
            state.stepData[state.currentStep].status = status;
            renderStep(state.currentStep);
        }

        function nextStep() {
            const notes = document.getElementById('notes');
            if (notes) {
                state.stepData[state.currentStep].notes = notes.value;
            }

            const currentData = state.stepData[state.currentStep];
            if (!currentData.photo) {
                alert('Please capture or upload a photo before proceeding');
                return;
            }
            if (!currentData.status) {
                alert('Please select Pass or Fail');
                return;
            }

            if (state.currentStep < CONFIG.steps.length - 1) {
                state.currentStep++;
                renderStep(state.currentStep);
            } else {
                renderCompletion();
            }
        }

        function previousStep() {
            const notes = document.getElementById('notes');
            if (notes) {
                state.stepData[state.currentStep].notes = notes.value;
            }

            stopCamera();
            state.currentStep--;
            renderStep(state.currentStep);
        }

        async function downloadEvidence() {
            const zip = new JSZip();

            const testerInfoText = Object.entries(state.testerInfo)
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n');

            zip.file('00_tester_info.txt', testerInfoText);

            for (let i = 0; i < state.stepData.length; i++) {
                const stepData = state.stepData[i];
                const stepFolder = zip.folder(`${String(i + 1).padStart(2, '0')}_${stepData.stepId}`);

                if (stepData.photo) {
                    const base64Data = stepData.photo.split(',')[1];
                    stepFolder.file('photo.jpg', base64Data, { base64: true });
                }

                const stepInfo = `Step: ${stepData.stepTitle}
Status: ${stepData.status.toUpperCase()}
Notes: ${stepData.notes || 'No notes provided'}
Timestamp: ${new Date().toISOString()}`;

                stepFolder.file('step_info.txt', stepInfo);
            }

            const content = await zip.generateAsync({ type: 'blob' });
            const fileName = `test_evidence_${state.testerInfo.testerId || 'unknown'}_${Date.now()}.zip`;
            saveAs(content, fileName);
        }

        function updateProgress(title, step) {
            document.getElementById('headerTitle').textContent = title;
            if (step === 0) {
                document.getElementById('progressText').textContent = 'Getting Started';
            } else {
                document.getElementById('progressText').textContent = `Step ${step} of ${CONFIG.steps.length}`;
            }
        }

        window.onload = init;

        window.onbeforeunload = () => {
            stopCamera();
        };
    </script>
</body>
</html>
